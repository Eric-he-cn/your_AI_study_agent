# Course Learning Agent - é¡¹ç›®è¯´æ˜

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ **AI è¯¾ç¨‹å­¦ä¹ åŠ©æ‰‹** é¡¹ç›®ï¼Œä¸“é—¨ä¸ºå¤§å­¦ç”Ÿè¯¾ç¨‹å­¦ä¹ è®¾è®¡ã€‚ä¸é€šç”¨ AI åŠ©æ‰‹ä¸åŒï¼Œæœ¬ç³»ç»Ÿæä¾›ï¼š

1. **åŸºäºæ•™æçš„ RAG ç³»ç»Ÿ** - æ‰€æœ‰å›ç­”éƒ½æœ‰æ•™æå¼•ç”¨
2. **ä¸‰ç§å­¦ä¹ æ¨¡å¼** - å­¦ä¹ ã€ç»ƒä¹ ã€è€ƒè¯•
3. **å¤š Agent åä½œ** - Routerã€Tutorã€QuizMasterã€Grader
4. **å·¥å…·å¯æ§é›†æˆ** - ä¸åŒæ¨¡å¼é™åˆ¶ä¸åŒå·¥å…·
5. **æŒä¹…åŒ–è®°å¿†ç³»ç»Ÿ** - SQLite å­˜å‚¨å­¦ä¹ å†å²ä¸è–„å¼±çŸ¥è¯†ç‚¹
6. **å®Œæ•´å­¦ä¹ é—­ç¯** - ä»ç†è§£åˆ°ç»ƒä¹ åˆ°è€ƒè¯•

## ğŸ“ ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1. æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Streamlit Frontend                 â”‚
â”‚    (è¯¾ç¨‹é€‰æ‹© | æ¨¡å¼åˆ‡æ¢ | å¯¹è¯ç•Œé¢ | æ–‡ä»¶ç®¡ç†)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP / SSE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FastAPI Backend                     â”‚
â”‚      (Workspaceç®¡ç† | æ–‡ä»¶ä¸Šä¼  | ç´¢å¼•ç®¡ç† | å¯¹è¯)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Orchestration Runner (ç¼–æ’å™¨)             â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          Router Agent (è§„åˆ’å™¨)                â”‚  â”‚
â”‚  â”‚   è¾“å…¥: ç”¨æˆ·æ¶ˆæ¯ + æ¨¡å¼ + è¯¾ç¨‹                 â”‚  â”‚
â”‚  â”‚   è¾“å‡º: Plan (need_rag, allowed_tools, ...)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â”‚                                â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚         â–¼           â–¼           â–¼                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚    â”‚ Tutor  â”‚ â”‚QuizMstr â”‚ â”‚ Grader â”‚              â”‚
â”‚    â”‚ Agent  â”‚ â”‚ Agent   â”‚ â”‚ Agent  â”‚              â”‚
â”‚    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â”‚
â”‚        â”‚           â”‚           â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚  RAG   â”‚  â”‚  MCP   â”‚  â”‚ Memory â”‚
    â”‚ System â”‚  â”‚ Tools  â”‚  â”‚  (DB)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒæ¨¡å—è¯´æ˜

#### A. RAG ç³»ç»Ÿ (rag/)

**åŠŸèƒ½**: æ–‡æ¡£æ£€ç´¢å¢å¼ºç”Ÿæˆ

**æµç¨‹**:
```
PDF/TXT/MD/DOCX/PPTX/PPT â†’ è§£æ â†’ åˆ†å— â†’ Embedding â†’ FAISS ç´¢å¼•
                                          â†“
ç”¨æˆ·æŸ¥è¯¢ â†’ Embedding â†’ ç›¸ä¼¼åº¦æ£€ç´¢ â†’ Top-K ç»“æœ â†’ å¸¦å¼•ç”¨çš„ä¸Šä¸‹æ–‡
```

**å…³é”®æ–‡ä»¶**:
- `ingest.py`: æ–‡æ¡£è§£æ (æ”¯æŒ PDF, TXT, MD, DOCX, PPTX, PPT)
- `chunk.py`: æ–‡æœ¬åˆ†å— (æ»‘çª— + overlap)
- `embed.py`: å‘é‡åµŒå…¥ (Sentence Transformers)
- `store_faiss.py`: FAISS å‘é‡å­˜å‚¨ï¼ˆå¹³é“ºæ–‡ä»¶ `.faiss` + `.pkl`ï¼Œçº¿ç¨‹é”ä¿æŠ¤ï¼‰
- `retrieve.py`: æ£€ç´¢ + å¼•ç”¨ç”Ÿæˆ

#### B. Agent ç³»ç»Ÿ (core/agents/)

**Router Agent** (router.py)
- èŒè´£: åˆ†æç”¨æˆ·è¯·æ±‚ï¼Œåˆ¶å®šæ‰§è¡Œè®¡åˆ’
- è¾“å…¥: ç”¨æˆ·æ¶ˆæ¯ã€æ¨¡å¼ã€è¯¾ç¨‹ä¿¡æ¯
- è¾“å‡º: Plan å¯¹è±¡
- å†³ç­–: æ˜¯å¦éœ€è¦ RAGï¼Ÿå…è®¸å“ªäº›å·¥å…·ï¼Ÿé‡‡ç”¨ä»€ä¹ˆé£æ ¼ï¼Ÿ

**Tutor Agent** (tutor.py)
- èŒè´£: æ•™å­¦è®²è§£ï¼Œæ¦‚å¿µè¯´æ˜
- è¾“å…¥: é—®é¢˜ + æ•™æä¸Šä¸‹æ–‡
- è¾“å‡º: ç»“æ„åŒ–æ•™å­¦å†…å®¹ï¼ˆå®šä¹‰ã€è§£é‡Šã€è¦ç‚¹ã€å¼•ç”¨ã€æ€»ç»“ï¼‰
- ç‰¹ç‚¹: è¯æ®ä¼˜å…ˆï¼Œå¿…é¡»å¼•ç”¨æ•™æï¼›æ³¨å…¥ç”¨æˆ·è–„å¼±çŸ¥è¯†ç‚¹ç”»åƒ

**QuizMaster Agent** (quizmaster.py)
- èŒè´£: ç”Ÿæˆç»ƒä¹ é¢˜
- è¾“å…¥: è¯¾ç¨‹ã€ä¸»é¢˜ã€éš¾åº¦ã€æ•™æä¸Šä¸‹æ–‡
- è¾“å‡º: Quiz å¯¹è±¡ï¼ˆé¢˜ç›®ã€æ ‡å‡†ç­”æ¡ˆã€è¯„åˆ†æ ‡å‡†ï¼‰
- ç‰¹ç‚¹: åŸºäºæ•™æå‡ºé¢˜ï¼Œéš¾åº¦å¯æ§

**Grader Agent** (grader.py)
- èŒè´£: è¯„åˆ†å’Œè®²è¯„
- è¾“å…¥: é¢˜ç›®ã€æ ‡å‡†ç­”æ¡ˆã€è¯„åˆ†æ ‡å‡†ã€å­¦ç”Ÿç­”æ¡ˆ
- è¾“å‡º: GradeReportï¼ˆåˆ†æ•°ã€åé¦ˆã€é”™è¯¯åˆ†ç±»ï¼‰
- ç‰¹ç‚¹: å¼ºåˆ¶é€é¢˜å¯¹ç…§è¡¨ï¼ˆCoTï¼‰ï¼Œç»™å‡ºå»ºè®¾æ€§åé¦ˆï¼Œæ ‡æ³¨é”™è¯¯ç±»å‹

#### C. MCP å·¥å…· (mcp_tools/)

**å·¥å…·é›†**:

| å·¥å…· | å­¦ä¹  | ç»ƒä¹  | è€ƒè¯• | åŠŸèƒ½ |
|------|:----:|:----:|:----:|------|
| `calculator` | âœ… | âœ… | âœ… | æ•°å­¦è®¡ç®—ï¼ˆmath/statistics/ç»„åˆæ•°å­¦/åŒæ›²å‡½æ•°/å•ä½æ¢ç®—ï¼‰ |
| `websearch` | âœ… | âŒ | âŒ | SerpAPI ç½‘é¡µæœç´¢ |
| `filewriter` | âœ… | âœ… | âŒ | å†™å…¥ `notes/` ç¬”è®°ï¼ˆ`.md` æ ¼å¼ï¼‰ |
| `memory_search` | âœ… | âœ… | âŒ | æ£€ç´¢å†å²ç»ƒä¹ /é”™é¢˜ï¼Œè‡ªåŠ¨å¼ºåŒ–è–„å¼±ç‚¹ |
| `mindmap_generator` | âœ… | âŒ | âŒ | ç”Ÿæˆ Mermaid æ€ç»´å¯¼å›¾ï¼Œæ”¯æŒ SVG/PNG å¯¼å‡º |
| `get_datetime` | âœ… | âœ… | âœ… | æŸ¥è¯¢ç²¾ç¡®æ—¥æœŸæ—¶é—´ï¼Œé¿å… LLM å‡­è®­ç»ƒæ•°æ®çŒœæµ‹ |

**å·¥å…·ç­–ç•¥** (policies.py):
```python
MODE_POLICIES = {
    "learn":    ["calculator", "websearch", "filewriter", "memory_search", "mindmap_generator", "get_datetime"],
    "practice": ["calculator", "filewriter", "memory_search", "get_datetime"],
    "exam":     ["calculator", "get_datetime"]
}
```

#### D. è®°å¿†ç³»ç»Ÿ (memory/)

**å­˜å‚¨**: SQLiteï¼Œè·¯å¾„ `data/memory/memory.db`

**è¡¨ç»“æ„**:
- `episodes`: æ¯æ¬¡ç»ƒä¹ /è€ƒè¯•/é”™é¢˜çš„è¯¦ç»†è®°å½•ï¼ˆtimestampã€courseã€typeã€contentã€scoreï¼‰
- `user_profiles`: æ¯é—¨è¯¾ç¨‹çš„è–„å¼±çŸ¥è¯†ç‚¹èšåˆï¼ˆweak_pointsã€practice_countã€avg_scoreï¼‰

**å†™å…¥æ—¶æœº**:
- ç»ƒä¹ è¯„åˆ†å®Œæˆ â†’ `_save_grading_to_memory()` â†’ å†™ `practice`/`mistake` episode
- è€ƒè¯•æ‰¹æ”¹å®Œæˆ â†’ `_save_exam_to_memory()` â†’ å†™ `exam` episode
- æ¯æ¬¡å†™å…¥è‡ªåŠ¨è°ƒç”¨ `update_weak_points()` + `record_practice_result()` æ›´æ–°ç”¨æˆ·ç”»åƒ

**ç”¨æˆ·ç”»åƒæ³¨å…¥**: Tutor/QuizMaster åœ¨ system prompt ä¸­è‡ªåŠ¨é™„åŠ å¼±ç‚¹åˆ—è¡¨ï¼Œä¼˜å…ˆé’ˆå¯¹è–„å¼±çŸ¥è¯†ç‚¹è®²è§£å’Œå‡ºé¢˜ã€‚

### 3. æ•°æ®æµè¯¦è§£

#### å­¦ä¹ æ¨¡å¼æµç¨‹

```
ç”¨æˆ·: "ä»€ä¹ˆæ˜¯çŸ©é˜µçš„ç§©?"
  â†“
FastAPI (/chat/stream endpoint) â†’ SSE æµå¼å“åº”
  â†“
OrchestrationRunner.run(mode="learn")
  â†“
Router.plan() â†’ Plan(need_rag=True, allowed_tools=["calculator","websearch",...])
  â†“
Retriever.retrieve("çŸ©é˜µçš„ç§©") â†’ [æ•™æç‰‡æ®µ1, ç‰‡æ®µ2, ç‰‡æ®µ3]
  â†“
Memory.get_profile_context(course) â†’ ç”¨æˆ·è–„å¼±çŸ¥è¯†ç‚¹ï¼ˆæ³¨å…¥ system promptï¼‰
  â†“
Tutor.teach_stream(question, context) â†’ é€ token æµå¼å›ç­”
  â†“
è‹¥è°ƒç”¨ mindmap_generator â†’ è¿”å› Mermaid ä»£ç å— â†’ å‰ç«¯æ¸²æŸ“ä¸ºäº¤äº’å›¾è¡¨
```

#### ç»ƒä¹ æ¨¡å¼æµç¨‹

```
ã€ç¬¬ä¸€è½®ï¼šå‡ºé¢˜ã€‘
ç”¨æˆ·: "ç»™æˆ‘å‡ºä¸€é“çŸ©é˜µç§©çš„é¢˜"
  â†“
QuizMaster.generate_quiz() â†’ Quiz å¯¹è±¡ â†’ æ˜¾ç¤ºé¢˜ç›®

ã€ç¬¬äºŒè½®ï¼šè¯„åˆ†ã€‘
ç”¨æˆ·: "ç­”æ¡ˆæ˜¯..."
  â†“
runner._is_practice_grading() == True
  â†“
å†…è” LLM è¯„åˆ† â†’ å¼ºåˆ¶å…ˆè¾“å‡º | é¢˜å· | æ ‡å‡†ç­”æ¡ˆ | å­¦ç”Ÿç­”æ¡ˆ | ç»“æœ | å¯¹ç…§è¡¨
  â†“
_save_practice_record()    â†’ å†™ practices/ JSON æ–‡ä»¶
_save_grading_to_memory()  â†’ å†™ SQLite è®°å¿†åº“ + æ›´æ–°ç”¨æˆ·ç”»åƒ
  â†“
å¦‚æœ score < 60 â†’ ä¿å­˜åˆ°é”™é¢˜æœ¬ (mistakes.jsonl)
```

#### è€ƒè¯•æ¨¡å¼æµç¨‹

```
ç”¨æˆ·: "æ¥ä¸€å¥—çº¿æ€§ä»£æ•°ç»¼åˆæµ‹è¯•"
  â†“
QuizMaster ç”Ÿæˆå®Œæ•´è¯•å·ï¼ˆå¤šé¢˜ï¼‰
  â†“
ç”¨æˆ·ä¸€æ¬¡æ€§æäº¤æ‰€æœ‰ç­”æ¡ˆ
  â†“
runner._is_exam_grading() == True
  â†“
å†…è” LLM æ‰¹æ”¹ â†’ è¾“å‡ºé€é¢˜æ‰¹æ”¹ + æ€»åˆ† + è–„å¼±çŸ¥è¯†ç‚¹åˆ†æ
  â†“
_save_exam_record()       â†’ å†™ exams/ JSON æ–‡ä»¶
_save_exam_to_memory()    â†’ å†™ SQLite è®°å¿†åº“ + æ›´æ–°ç”¨æˆ·ç”»åƒ
```

## ğŸ¨ å‰ç«¯ç•Œé¢è®¾è®¡

### å¸ƒå±€ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯¾ç¨‹å­¦ä¹ åŠ©æ‰‹ ğŸ“š                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¾§è¾¹æ       â”‚  [è¯¾ç¨‹å] [æ¨¡å¼å¾½ç« ]  [â“å¸®åŠ©] [ğŸ—‘å†å²] â”‚
â”‚             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ [è¯¾ç¨‹é€‰æ‹©]   â”‚  â”Œ æ¨¡å¼æŒ‡ç¤ºæ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”  â”‚
â”‚  çº¿æ€§ä»£æ•°    â”‚  â”‚ ğŸ“– å­¦ä¹ æ¨¡å¼  åŸºäºæ•™æç²¾å‡†è®²è§£â€¦   â”‚  â”‚
â”‚  é€šä¿¡åŸç†    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”˜  â”‚
â”‚  + æ–°å»º      â”‚                                        â”‚
â”‚             â”‚  ğŸ’¬ å¯¹è¯åŒº                              â”‚
â”‚ [æ¨¡å¼é€‰æ‹©]   â”‚  User: ä»€ä¹ˆæ˜¯çŸ©é˜µçš„ç§©ï¼Ÿ               â”‚
â”‚  â—‹ å­¦ä¹      â”‚  Assistant: [å›ç­”å†…å®¹]                â”‚
â”‚  â—‹ ç»ƒä¹      â”‚    ğŸ“‘ æŸ¥çœ‹å¼•ç”¨ â–¼                      â”‚
â”‚  â—‹ è€ƒè¯•     â”‚    ğŸ”§ å·¥å…·è°ƒç”¨ â–¼                      â”‚
â”‚             â”‚    ğŸ—º [Mermaid æ€ç»´å¯¼å›¾äº¤äº’å›¾]         â”‚
â”‚ [ğŸ“æ–‡ä»¶ä¸ç´¢å¼•]â”‚    [â¬‡ SVG] [â¬‡ PNG] [â¬‡ .mmd]        â”‚
â”‚  file1.pdf  â”‚                                        â”‚
â”‚  file2.pptx â”‚  [è¾“å…¥æ¡†: è¾“å…¥ä½ çš„é—®é¢˜...]              â”‚
â”‚  ğŸ”¨ æ„å»ºç´¢å¼•  â”‚                                        â”‚
â”‚  ğŸ—‘ åˆ é™¤æ–‡ä»¶  â”‚                                        â”‚
â”‚  ğŸ—‘ åˆ é™¤ç´¢å¼•  â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äº¤äº’ç‰¹æ€§

1. **æ¨¡å¼ä¸»é¢˜è‰²**: å­¦ä¹ =è“è‰²ã€ç»ƒä¹ =ç»¿è‰²ã€è€ƒè¯•=ç¥ç€è‰²ï¼ˆæ¨¡å¼å¾½ç«  + å·¦ä¾§æŒ‡ç¤ºæ¡ï¼‰
2. **Mermaid æ€ç»´å¯¼å›¾**: å†…åµŒäº¤äº’æ¸²æŸ“ï¼ˆå‰ç«¯ HTML ç»„ä»¶ï¼‰ï¼Œæ”¯æŒç¼©æ”¾ï¼›3Ã— è¶…é‡‡æ · PNG å¯¼å‡º
3. **å¸®åŠ©é¢æ¿**: â“ æŒ‰é’®åˆ‡æ¢ï¼Œå†…åµŒå¿«é€Ÿå¼€å§‹æŒ‡å—
4. **æ–‡ä»¶ç®¡ç†**: ä¾§è¾¹æ æ˜¾ç¤ºæ–‡ä»¶å¤§å°/æ—¥æœŸï¼Œæ”¯æŒå•ç‹¬åˆ é™¤æ–‡ä»¶ã€åˆ é™¤ç´¢å¼•
5. **æ¸…ç©ºå†å²**: ä¸»åŒºåŸŸä¸€é”®æ¸…ç©ºå¯¹è¯å†å²
6. **å®æ—¶æµå¼**: SSE é€ token æ¨é€ï¼Œå‰ç«¯ Streamlit å®æ—¶æ‹¼æ¥æ¸²æŸ“

## ğŸ“Š æ•°æ®å­˜å‚¨ç»“æ„

```
data/
â”œâ”€â”€ memory/
â”‚   â””â”€â”€ memory.db              # SQLite è®°å¿†åº“ï¼ˆepisodes + user_profilesï¼‰
â””â”€â”€ workspaces/
    â””â”€â”€ çº¿æ€§ä»£æ•°/
        â”œâ”€â”€ uploads/           # åŸå§‹æ–‡æ¡£
        â”‚   â”œâ”€â”€ æ•™æç¬¬ä¸€ç« .pdf
        â”‚   â”œâ”€â”€ è¯¾å ‚è®²ä¹‰.txt
        â”‚   â””â”€â”€ æ€ç»´å¯¼å›¾.pptx
        â”œâ”€â”€ index/             # å‘é‡ç´¢å¼•ï¼ˆå¹³é“ºæ–‡ä»¶ï¼Œéç›®å½•ï¼‰
        â”‚   â”œâ”€â”€ faiss_index.faiss
        â”‚   â””â”€â”€ faiss_index.pkl
        â”œâ”€â”€ notes/             # AI ä¿å­˜çš„ Markdown ç¬”è®°
        â”œâ”€â”€ mistakes/          # é”™é¢˜æœ¬
        â”‚   â””â”€â”€ mistakes.jsonl
        â”œâ”€â”€ practices/         # ç»ƒä¹ è®°å½•
        â”‚   â””â”€â”€ practice_20260222_143000.json
        â””â”€â”€ exams/             # è€ƒè¯•è®°å½•
            â””â”€â”€ exam_20260222_160000.json
```

### mistakes.jsonl æ ¼å¼

```json
{"timestamp": "2026-02-22T10:30:00", "question": "...", "student_answer": "...", "score": 75, "feedback": "...", "mistake_tags": ["æ­¥éª¤ç¼ºå¤±"]}
```

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. RAG å®ç°

**åˆ†å—ç­–ç•¥**:
```python
chunk_size = 600      # å­—ç¬¦æ•°ï¼ˆä¸­æ–‡å¯†åº¦é«˜ï¼‰
overlap = 120         # é‡å å­—ç¬¦æ•°ï¼ˆâ‰ˆ20%ï¼Œé˜²æ­¢æœ¯è¯­è·¨å—æˆªæ–­ï¼‰
```

**åµŒå…¥ç­–ç•¥**:
```python
model = "BAAI/bge-base-zh-v1.5"   # ä¸­æ–‡ä¸“ç”¨ï¼Œ768 ç»´
device = "cuda"  # æˆ– "cpu"ï¼ˆauto-detect via torch.cuda.is_available()ï¼‰
batch_size = 256  # GPUï¼›CPU æ—¶é™ä¸º 32
```

**æ£€ç´¢ç­–ç•¥**:
```python
top_k = 6            # è¿”å›å‰6ä¸ªæœ€ç›¸å…³ç‰‡æ®µ
similarity = L2      # normalize_embeddings=True ç­‰ä»·ä½™å¼¦
```

### 2. Prompt Engineering

- **ç»“æ„åŒ–è¾“å‡º**: æ‰€æœ‰ Agent çš„ Prompt ç”Ÿæˆç»“æ„åŒ–è¾“å‡ºï¼ˆJSON æˆ–å›ºå®šæ ¼å¼ï¼‰
- **è¯æ®ä¼˜å…ˆ**: Tutor Agent å¼ºåˆ¶å¼•ç”¨æ•™æ
- **CoT è¯„åˆ†**: Grader/ç»ƒä¹ è¯„åˆ†å¿…é¡»å…ˆè¾“å‡ºé€é¢˜å¯¹ç…§è¡¨ï¼Œå†è®¡ç®—æ€»åˆ†
- **MCQ æ ¼å¼**: é€‰é¡¹å¼ºåˆ¶æ¯è¡Œä¸€ä¸ªï¼Œåˆ¤æ–­é¢˜å¸¦ `ï¼ˆ ï¼‰` æ‹¬å·

### 3. é”™è¯¯å¤„ç†

- LLM è°ƒç”¨å¤±è´¥ â†’ è¿”å›é”™è¯¯æ¶ˆæ¯
- JSON è§£æå¤±è´¥ â†’ ä½¿ç”¨é»˜è®¤å€¼
- æ–‡ä»¶ä¸Šä¼ å¤±è´¥ â†’ å‰ç«¯æç¤º
- ç´¢å¼•ä¸å­˜åœ¨ â†’ æç¤ºç”¨æˆ·å…ˆå»ºç´¢å¼•
- è®°å¿†åº“å†™å…¥å¤±è´¥ â†’ é™é»˜è·³è¿‡ï¼Œä¸å½±å“ä¸»æµç¨‹

### 4. å¯æ‰©å±•æ€§è®¾è®¡

**æ–°å¢ Agent**:
```python
# 1. åœ¨ core/agents/ åˆ›å»ºæ–° agent æ–‡ä»¶
# 2. åœ¨ prompts.py æ·»åŠ  prompt æ¨¡æ¿
# 3. åœ¨ runner.py æ·»åŠ è°ƒç”¨é€»è¾‘
```

**æ–°å¢å·¥å…·**:
```python
# åœ¨ mcp_tools/client.py æ·»åŠ  schema + å®ç° + call_tool è·¯ç”±
# åœ¨ policies.py æŒ‰æ¨¡å¼é…ç½®å…è®¸åˆ—è¡¨
# åœ¨ tutor.py system prompt æ·»åŠ ä½¿ç”¨è§„åˆ™
@staticmethod
def new_tool(param):
    return {"tool": "new_tool", "result": ..., "success": True}
```

**æ–°å¢æ¨¡å¼**:
```python
# 1. åœ¨ schemas.py æ·»åŠ åˆ° Literal ç±»å‹
# 2. åœ¨ policies.py é…ç½®å·¥å…·ç­–ç•¥
# 3. åœ¨ runner.py æ·»åŠ æ¨¡å¼å¤„ç†é€»è¾‘
```

## ğŸ¯ æ ¸å¿ƒåˆ›æ–°ç‚¹

### 1. è¯æ®ä¼˜å…ˆæ¶æ„
- å¼ºåˆ¶è¦æ±‚å¼•ç”¨æ•™ææ¥æºï¼Œæ˜¾ç¤ºé¡µç å’Œæ–‡æ¡£å

### 2. å­¦ä¹ é—­ç¯è®¾è®¡
```
ç†è§£ (Learn) â†’ ç»ƒä¹  (Practice) â†’ æ£€æµ‹ (Exam) â†’ å¤ä¹  (é”™é¢˜æœ¬+è®°å¿†åº“)
     â†‘                                                    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ memory_search å¼±ç‚¹åé¦ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å·¥å…·ç­–ç•¥æ§åˆ¶
- ä¸åŒæ¨¡å¼ä¸åŒç­–ç•¥ï¼Œè€ƒè¯•æ¨¡å¼é˜²ä½œå¼Šï¼Œæ‰€æœ‰è°ƒç”¨å¯è§‚æµ‹

### 4. Agent èŒè´£åˆ†ç¦»
- Router: è§„åˆ’ Â· Tutor: æ•™å­¦ Â· QuizMaster: å‡ºé¢˜ Â· Grader: è¯„åˆ†

### 5. æŒä¹…åŒ–è®°å¿†
- SQLite è·¨ä¼šè¯è¿½è¸ªè–„å¼±ç‚¹ï¼ŒAI è‡ªåŠ¨åœ¨è–„å¼±çŸ¥è¯†ç‚¹ä¸ŠåŠ å¼º

## ğŸš€ éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒ
```bash
conda activate study_agent
python -m backend.api                        # åç«¯: localhost:8000
streamlit run frontend/streamlit_app.py      # å‰ç«¯: localhost:8501
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
gunicorn backend.api:app -w 4 -k uvicorn.workers.UvicornWorker
# nginx åä»£ â†’ 8000
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **API Key ä¿æŠ¤**: ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä¸æäº¤åˆ°ä»£ç åº“
2. **æ–‡ä»¶ä¸Šä¼ é™åˆ¶**: ç™½åå•ç±»å‹ï¼ˆPDF/TXT/MD/DOCX/PPTX/PPTï¼‰ï¼Œ`basename()` é˜²è·¯å¾„ç©¿è¶Š
3. **è¡¨è¾¾å¼æ‰§è¡Œ**: Calculator ä½¿ç”¨é™å®šå‘½åç©ºé—´çš„ `eval`ï¼Œæ— å†…å»ºå‡½æ•°
4. **æ•°æ®éš”ç¦»**: æ¯ä¸ªè¯¾ç¨‹ç‹¬ç«‹å·¥ä½œç©ºé—´ï¼Œè¯¾ç¨‹åç» `basename()` æ¸…æ´—
5. **FAISS çº¿ç¨‹å®‰å…¨**: æ¨¡å—çº§ `threading.Lock` ä¿æŠ¤ `os.chdir()` åŒºåŸŸ
6. **å†å²æˆªæ–­**: å¯¹è¯å†å²ä»…å–æœ€è¿‘ 20 æ¡ï¼Œé˜²æ­¢ token çˆ†ç‚¸ä¸æ•°æ®æ³„æ¼

## ğŸ“š è°ƒè¯•æŠ€å·§

1. æŸ¥çœ‹åç«¯æ—¥å¿—äº†è§£ API è°ƒç”¨å’Œå·¥å…·è°ƒç”¨é“¾
2. æŸ¥çœ‹ LLM è¿”å›çš„åŸå§‹æ–‡æœ¬ï¼ˆRunner æ—¥å¿—ï¼‰
3. æ£€æŸ¥ `data/workspaces/<course>/index/faiss_index.faiss` æ˜¯å¦å­˜åœ¨
4. æ£€æŸ¥ `data/memory/memory.db` çš„ `episodes` è¡¨ç¡®è®¤è®°å¿†æ˜¯å¦å†™å…¥
5. éªŒè¯ `.env` é…ç½®æ˜¯å¦æ­£ç¡®

---

## ğŸ’¡ æ ¸å¿ƒä»·å€¼æ€»ç»“

âœ… **äº§å“åŒ–çš„å­¦ä¹ ç³»ç»Ÿ** - å®Œæ•´çš„å­¦ä¹ é—­ç¯  
âœ… **å¯æ§çš„ Agent åº”ç”¨** - å·¥å…·ç­–ç•¥ + æ¨¡å¼è®¾è®¡  
âœ… **å¯è¿½æº¯çš„çŸ¥è¯†ç³»ç»Ÿ** - è¯æ®ä¼˜å…ˆ + å¼•ç”¨æ ‡æ³¨  
âœ… **æŒä¹…åŒ–è®°å¿†å¢å¼º** - è·¨ä¼šè¯å¼±ç‚¹è¿½è¸ªä¸å¼ºåŒ–  
âœ… **å¯æ‰©å±•çš„æ¶æ„** - æ¨¡å—åŒ– + Agent ç¼–æ’  