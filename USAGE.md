# 使用手册 — Your AI Study Agent

> 本手册面向日常使用者，按操作流程逐步说明。如需开发/部署细节请参阅 [README.md](README.md)。

---

## 目录

1. [启动系统](#1-启动系统)
2. [课程管理](#2-课程管理)
3. [上传教材与构建索引](#3-上传教材与构建索引)
4. [学习模式](#4-学习模式)
5. [练习模式](#5-练习模式)
6. [考试模式](#6-考试模式)
7. [MCP 工具使用](#7-mcp-工具使用)
8. [记录与数据管理](#8-记录与数据管理)
9. [提问技巧与最佳实践](#9-提问技巧与最佳实践)
10. [常见问题](#10-常见问题)

---

## 1. 启动系统

每次使用前需同时启动后端和前端两个进程。

```bash
# 终端 1 — 后端（FastAPI）
conda activate study_agent
python -m backend.api
# 看到 "Uvicorn running on http://0.0.0.0:8000" 表示成功

# 终端 2 — 前端（Streamlit）
conda activate study_agent
streamlit run frontend/streamlit_app.py
# 浏览器自动打开 http://localhost:8501
```

> **注意**：后端必须先于前端启动，否则前端连接会报 `Connection refused`。

---

## 2. 课程管理

### 2.1 创建课程

1. 打开 `http://localhost:8501`
2. 侧边栏 → **➕ 创建新课程**
3. 填写：
   - **课程名称**：将用于文件夹命名，建议使用中文或英文，避免特殊字符（`/ \ : * ? " < > |`）
   - **学科标签**：如 `数学`、`通信原理`
4. 点击 **创建**

创建成功后，系统会在 `data/workspaces/<课程名称>/` 下自动初始化以下目录：

```
uploads/      ← 原始文件存放位置
index/        ← FAISS 向量索引（.faiss + .pkl）
notes/        ← AI 保存的学习笔记
mistakes/     ← 错题记录（mistakes.jsonl）
practices/    ← 练习对话记录（自动保存）
exams/        ← 考试记录（自动保存）
```

### 2.2 切换课程

侧边栏下拉菜单选择已有课程，切换后聊天记录和知识库同步切换。

### 2.3 删除课程

通过 API 调用删除（前端暂未提供删除按钮）：

```bash
curl -X DELETE http://localhost:8000/workspaces/线性代数
```

> ⚠️ 删除后数据不可恢复，请提前备份 `data/workspaces/<课程名称>/` 目录。

---

## 3. 上传教材与构建索引

### 3.1 支持的文件格式

| 格式 | 说明 |
|------|------|
| `.pdf` | 文字版 PDF（扫描版无法提取文本） |
| `.txt` | 自动识别编码（UTF-8 / GBK / Latin-1） |
| `.md` | Markdown 文档 |
| `.docx` | Word 文档 |
| `.pptx` | PowerPoint 文档（每张幻灯片按一页提取） |
| `.ppt` | 旧版 PowerPoint（先转换为 `.pptx` 再解析） |

> 说明：解析 `.ppt` 需要本机安装 Microsoft PowerPoint（Windows COM 转换）。如环境不满足，建议先手动转为 `.pptx` 再上传。

### 3.2 上传步骤

1. 侧边栏 → 选择课程 → **📁 上传资料**
2. 点击文件选择框，可多选
3. 点击 **上传**，等待进度条完成

### 3.3 构建索引

上传完成后**必须构建索引**，AI 才能检索教材内容：

1. 侧边栏 → **🔨 构建索引**
2. 等待完成（会显示 `索引构建完成，共 N 个文本块`）

> **首次构建**会自动下载嵌入模型 `BAAI/bge-base-zh-v1.5`（约 400 MB），请耐心等待。  
> 如果有 NVIDIA GPU（驱动 ≥ 570），会自动切换 CUDA 加速，构建速度约快 5–8 倍。  
> 每次新增或替换教材后，都需要重新点击构建索引。  
> 批量重建所有课程可在项目根目录运行：`python rebuild_indexes.py`

### 3.4 文件管理

侧边栏 **📁 文件与索引** 面板功能：

| 操作 | 说明 |
|------|------|
| 文件列表 | 显示已上传文件、大小、上传时间 |
| 🗑 单文件删除 | 点击文件旁的删除按钮，仅删除该文件 |
| 🔨 构建/重建索引 | 对当前所有文件重建向量索引 |
| 🗑 删除索引 | 清除向量索引（不删除原始文件） |

### 3.5 教材命名建议

```
✅ 推荐：线性代数第一章_矩阵基础.pdf
✅ 推荐：Ch3_Linear_Systems.pdf
❌ 避免：文档1.pdf
❌ 避免：新建 Microsoft Word 文档.docx
```

有意义的文件名会出现在 AI 的引用来源中，方便溯源。

---

## 4. 学习模式

**适用场景**：理解新概念、复习知识点、查找定理证明、梳理知识脉络。

侧边栏选择模式 → **📖 学习**，然后在输入框提问。

### 4.1 AI 回答结构

```
## 1. 核心答案
## 2. 详细解释
## 3. 关键要点与易错点
## 4. 教材引用（来源文档名 + 页码 + 原文片段）
## 5. 知识点总结
```

### 4.2 提问示例

```
用户：什么是矩阵的秩？

用户：请结合教材第三章，解释线性方程组解的判别条件

用户：帮我整理向量空间到矩阵秩的知识脉络，并保存到笔记

用户：帮我生成线性代数第二章的思维导图
```

### 4.3 学习模式可用工具

| 工具 | 触发方式 | 说明 |
|------|----------|------|
| **计算器** | 提到需要计算的数值 | 自动调用，精确计算 |
| **网页搜索** | 问题超出教材范围 | 结合教材 + 搜索结果回答 |
| **文件写入** | "保存到笔记" / "记录下来" | 写入 `notes/` 目录（`.md` 格式） |
| **记忆检索** | 知识点与历史练习相关 | 自动提示曾经的错误与薄弱点 |
| **思维导图** | "帮我生成……思维导图" | 生成 Mermaid 图，可下载 SVG/PNG |
| **查询时间** | 询问当前日期/时间/星期 | 返回精确本地时间，不凭猜测回答 |

---

## 5. 练习模式

**适用场景**：做题训练、获得反馈、积累错题。

侧边栏选择 → **✍️ 练习**。

### 5.1 完整流程

```
第一步：请 AI 出题
用户：给我出一道关于矩阵秩的中等难度题目

第二步：AI 出题
助手：【练习题目】
      已知矩阵 A = [[1,2,3],[2,4,6],[1,2,1]]
      (1) 求矩阵 A 的秩
      (2) 判断行向量是否线性相关，说明理由

第三步：提交你的答案
用户：(1) rank(A) = 2
      (2) 线性相关，因为第二行是第一行的2倍

第四步：AI 评分与讲评
助手：【逐题对照】
      | 题号 | 标准答案 | 学生答案 | 结果 |
      | (1)  | 2        | 2        | ✓    |
      | (2)  | 线性相关（需分析第三行）| 仅分析前两行 | ✗ |
      得分：75/100
      [此次练习已自动保存至 practices/ 和记忆库]
```

### 5.2 指定出题参数

```
"出一道简单的矩阵乘法题"           ← 难度：easy
"来一道中等难度的特征值计算题"      ← 难度：medium
"出一道困难的综合证明题"            ← 难度：hard
"针对第三章线性方程组出题"          ← 指定章节
"给我连续出3道题，难度递增"         ← 批量练习
```

### 5.3 练习记录

每次完成评分后，完整对话自动保存至：

```
data/workspaces/<课程名>/practices/practice_YYYYMMDD_HHMMSS.json
```

同时，评分结果写入 SQLite 记忆库，AI 下次出题时会优先针对薄弱点。

---

## 6. 考试模式

**适用场景**：期末前自我检测、模拟真实考试环境。

侧边栏选择 → **📝 考试**。

### 6.1 与练习模式的区别

| 对比项 | 练习模式 | 考试模式 |
|--------|----------|----------|
| 网页搜索 | ❌ 禁用 | ❌ 禁用 |
| 计算器 | ✅ 可用 | ✅ 可用 |
| 文件写入 | ✅ 可用 | ❌ 禁用 |
| 记忆检索 | ✅ 可用 | ❌ 禁用 |
| 思维导图 | ❌ 禁用 | ❌ 禁用 |
| 查询时间 | ✅ 可用 | ✅ 可用 |
| 题目风格 | 单题 | 综合试卷 |
| 记录位置 | `practices/` | `exams/` |

### 6.2 使用建议

```
1. 自行设定计时器（如 90 分钟）
2. 输入考试指令启动：
   用户："来一套线性代数第一章综合测试"
3. 独立完成全部题目后，一次性提交答案
4. 查看考试报告，关注薄弱知识点和错误类型分析
```

### 6.3 考试记录

保存路径：`data/workspaces/<课程名>/exams/exam_YYYYMMDD_HHMMSS.json`  
考试结果同步写入记忆库，后续学习时 AI 会针对考试薄弱点强化。

---

## 7. MCP 工具使用

工具由 AI 自动调用，用户无需手动触发，了解其能力有助于更好地提问。

### 7.1 计算器

```
用户：计算 det([[2,1],[5,3]])
助手：行列式值为 1，矩阵可逆。
```

支持：四则运算、乘方、`math` 库（`sqrt/factorial/log/sin/cos`等）、`statistics` 库（`mean/stdev` 等）、组合数学（`comb/perm/gcd/lcm`）、双曲函数、常用单位换算。

> ⚠️ 计算器采用受限 `eval`，仅允许数学运算，不能执行任意 Python 代码。

### 7.2 网页搜索（仅学习模式）

```
用户：特征值在现实工程中有哪些应用？
助手：根据教材第4章定义，结合搜索结果……
```

需要配置 `SERPAPI_API_KEY`，否则该工具被跳过。

### 7.3 文件写入（学习/练习模式）

```
用户：把今天学的矩阵秩的内容整理成笔记保存
助手：已整理并保存至 notes/矩阵秩总结.md
```

笔记保存在 `data/workspaces/<课程名>/notes/`，可用任意文本编辑器查看。

### 7.4 思维导图（仅学习模式）

```
用户：帮我生成线性代数第二章的思维导图
助手：[生成 Mermaid 思维导图，前端渲染为交互图]
     [⬇ SVG]  [⬇ PNG（高清）]  [⬇ 源码 .mmd]
```

- SVG 矢量格式，可随意缩放
- PNG 以 3× 超采样导出，适合打印
- `.mmd` 源码可导入其他 Mermaid 工具

### 7.5 记忆检索（学习/练习模式）

AI 会在以下场景自动调用：
- 讲解某知识点时，检测到你曾在该知识点失分 → 主动提醒历史错误
- 练习出题时，优先从你的薄弱知识点取材

无需手动触发；也可主动说：
```
用户：回顾我所有关于"线性相关"的错题，帮我总结规律
```

### 7.6 查询日期时间（全模式）

```
用户：今天是几月几号？
助手：[调用 get_datetime] 今天是2026年2月23日，星期一。
```

AI 不会凭训练数据猜测日期，直接调用系统时钟返回精确结果。

---

## 8. 记录与数据管理

### 8.1 查看练习/考试记录

```bash
ls data/workspaces/线性代数/practices/
cat data/workspaces/线性代数/practices/practice_20260222_143000.json
```

### 8.2 错题本

错题保存于：`data/workspaces/<课程名>/mistakes/mistakes.jsonl`（每行一条 JSON）

```json
{
  "timestamp": "2026-02-22T14:30:00",
  "question": "题目",
  "student_answer": "学生答案",
  "standard_answer": "标准答案",
  "score": 60.0,
  "feedback": "详细反馈",
  "mistake_tags": ["步骤缺失", "概念混淆"]
}
```

### 8.3 记忆库

SQLite 路径：`data/memory/memory.db`

| 表 | 内容 |
|----|------|
| `episodes` | 每次练习/考试/错题详情 |
| `user_profiles` | 每门课程的薄弱知识点聚合、练习次数、平均分 |

基于记忆库复习：
```
用户：回顾我关于"特征值"的历史错误，帮我分析规律
```

### 8.4 学习笔记

路径：`data/workspaces/<课程名>/notes/`，Markdown 格式，可直接用 VS Code / Obsidian 打开。

### 8.5 备份数据

```bash
# 备份单门课程
cp -r data/workspaces/线性代数/ backup/线性代数/

# 备份记忆库
cp data/memory/memory.db backup/memory.db
```

---

## 9. 提问技巧与最佳实践

### 9.1 使用专业术语

```
✅ "根据秩-零化度定理，分析 Ax=0 的解空间维数"
❌ "那个矩阵方程有几个解"
```

### 9.2 指定范围与章节

```
✅ "第三章线性方程组中，何时方程组有唯一解？"
❌ "方程组怎么求解"
```

### 9.3 引用题目类型

```
✅ "出一道需要用初等行变换求秩的中等难度题"
✅ "给我一道关于特征值的证明题，难度困难"
```

### 9.4 学习闭环建议

```
周一：学习模式 → 理解新概念（可生成思维导图）
周二：练习模式 → 做题巩固
周三：练习模式 → 针对错题训练（AI 自动取材薄弱点）
周末：考试模式 → 综合自测
      ↓
查看错题本 + 记忆库 → 学习模式补缺
```

### 9.5 检索引用置信度参考

| 相关度分数 | 建议 |
|-----------|------|
| 0.8 ~ 1.0 | 高度相关，直接参考 |
| 0.6 ~ 0.8 | 较相关，建议对照原文 |
| < 0.6 | 弱相关，结合判断 |

---

## 10. 常见问题

### Q1：上传文件后 AI 说"未找到相关教材内容"

**原因**：索引未构建或文件内容为图片式扫描 PDF。  
**解决**：
1. 确认已点击「🔨 构建索引」并等待完成
2. 确认 PDF 文字可以手动复制（非扫描版）
3. 尝试重新上传并构建索引

### Q2：TXT 文件上传后内容显示乱码

**原因**（已修复）：当前版本按 UTF-8 → GBK → Latin-1 自动检测编码。  
**解决**：重新上传并构建索引即可。

### Q3：流式回答中途停止

**原因**：SSE 连接超时或后端异常。  
**解决**：检查后端终端是否有报错，刷新页面后重新提问。

### Q4：练习/考试记录没有自动保存

**原因**：记录仅在 AI **完成评分** 后保存，若对话在出题阶段结束则不保存。  
**解决**：提交答案并等待 AI 返回评分结果（看到逐题对照表后即已保存）。

### Q5：网页搜索没有触发

**原因**：`SERPAPI_API_KEY` 未配置，或当前模式不允许搜索。  
**解决**：
1. 检查 `.env` 中 `SERPAPI_API_KEY` 是否填写
2. 确认当前为**学习模式**（练习/考试模式禁用搜索）

### Q6：计算器返回错误

**原因**：表达式含不支持的函数或语法。  
**解决**：使用标准 Python 数学语法，乘方用 `**`，调用 `math.sqrt()` 等。

### Q7：课程名称创建失败

**原因**：课程名称含路径分隔符（`/ \`）或特殊字符。  
**解决**：使用纯汉字、英文、数字和空格命名。

### Q8：侧边栏显示"索引未构建"但实际已构建

**原因**（已修复）：旧版本用目录检测 FAISS 索引，但 FAISS 实际以平铺文件存储。  
**解决**：更新到最新版本后重新构建索引，状态会正确显示。

### Q9：思维导图 PNG 下载图片模糊

**原因**（已修复）：旧版本取 CSS 像素尺寸，受页面缩放影响。  
**解决**：更新到最新版本，PNG 以 3× 超采样导出，清晰度已提升。

### Q10：记忆库里看不到最近的练习/考试记录

**原因**（已修复）：旧版本练习/考试评分走内联 LLM，未触发记忆写入。  
**解决**：更新到最新版本，评分完成后记忆库自动同步。

---

> 如遇其他问题，请查看后端终端输出日志，或提交 [GitHub Issue](https://github.com/Eric-he-cn/your_AI_study_agent/issues)。

更新日期：2026-02-23